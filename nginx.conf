# ============================================================================
# Nginx Configuration for Laravel on Render
# ============================================================================
# 
# Architecture: Nginx (static files) → PHP-FPM (dynamic content) → Laravel
# 
# WHY this configuration?
# - Optimized for Laravel (root = public/, try_files for routing)
# - Separates static and dynamic content handling
# - Production-grade security and performance settings
# - Compatible with Render's dynamic port assignment
# ============================================================================

# Run as www-data user (security best practice)
user www-data;

# Auto-detect number of CPU cores for optimal performance
worker_processes auto;

# PID file location
pid /run/nginx.pid;

# Maximum number of open files per worker
worker_rlimit_nofile 65535;

events {
    # Maximum simultaneous connections per worker
    # WHY 2048? Balances performance and resource usage
    worker_connections 2048;
    
    # Use epoll for better performance on Linux
    use epoll;
    
    # Accept multiple connections at once
    multi_accept on;
}

http {
    ##
    # Basic Settings
    ##
    
    # Hide Nginx version for security
    server_tokens off;
    
    # Enable sendfile for better performance
    # WHY? Kernel handles file transfers directly (faster)
    sendfile on;
    
    # Send headers in one packet
    tcp_nopush on;
    
    # Don't buffer data-sends (good for small data bursts)
    tcp_nodelay on;
    
    # How long to keep connections open
    # WHY 65? Balances connection reuse and resource usage
    keepalive_timeout 65;
    
    # Maximum size of hash tables
    types_hash_max_size 2048;
    
    # Maximum allowed size of client request body
    # WHY 20M? Allows file uploads (resumes, images)
    client_max_body_size 20M;
    
    # Include MIME types
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    ##
    # SSL Settings (if needed in future)
    ##
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers on;

    ##
    # Logging Settings
    ##
    
    # Access log format
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';
    
    # Log to stdout (Render captures this)
    access_log /dev/stdout main;
    error_log /dev/stderr warn;

    ##
    # Gzip Settings (compression for better performance)
    ##
    
    # Enable gzip compression
    gzip on;
    
    # Compression level (1-9, 6 is good balance)
    gzip_comp_level 6;
    
    # Minimum file size to compress
    gzip_min_length 1000;
    
    # Compress these MIME types
    gzip_types text/plain text/css application/json application/javascript 
               text/xml application/xml application/xml+rss text/javascript 
               application/vnd.ms-fontobject application/x-font-ttf 
               font/opentype image/svg+xml image/x-icon;
    
    # Add Vary: Accept-Encoding header
    gzip_vary on;
    
    # Disable gzip for old IE
    gzip_disable "msie6";

    ##
    # Virtual Host Configuration
    ##
    
    server {
        # Listen on port from environment variable (Render provides $PORT)
        # Default to 10000 if $PORT not set
        # WHY? Render assigns port dynamically, we configure it at runtime
        listen ${PORT} default_server;
        listen [::]:${PORT} default_server;
        
        # Server name (can be anything for Render)
        server_name _;
        
        # Document root is Laravel's public directory
        # WHY public/? Laravel's entry point, prevents direct access to app code
        root /var/www/html/public;
        
        # Default index file
        index index.php index.html;
        
        # Character set
        charset utf-8;

        ##
        # Laravel-specific location blocks
        ##
        
        # Main location block - handles all requests
        location / {
            # Try to serve file directly, then directory, then Laravel router
            # WHY? Nginx serves static files, PHP handles dynamic routes
            try_files $uri $uri/ /index.php?$query_string;
        }
        
        # Handle PHP files
        location ~ \.php$ {
            # Security: Don't allow PHP execution in uploads directory
            # WHY? Prevents malicious PHP file uploads from being executed
            location ~ ^/storage/.*\.php$ {
                deny all;
            }
            
            # FastCGI configuration for PHP-FPM
            # WHY 127.0.0.1:9000? PHP-FPM listens on this port by default
            fastcgi_pass 127.0.0.1:9000;
            
            # FastCGI index file
            fastcgi_index index.php;
            
            # Include FastCGI parameters
            include fastcgi_params;
            
            # Set SCRIPT_FILENAME for PHP-FPM
            # WHY? Tells PHP-FPM which file to execute
            fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
            
            # Pass request path to PHP
            fastcgi_param PATH_INFO $fastcgi_path_info;
            
            # Increase timeouts for long-running requests
            fastcgi_read_timeout 300;
            fastcgi_send_timeout 300;
            
            # Buffer settings for better performance
            fastcgi_buffer_size 128k;
            fastcgi_buffers 256 16k;
            fastcgi_busy_buffers_size 256k;
            fastcgi_temp_file_write_size 256k;
        }
        
        # Deny access to hidden files (security)
        # WHY? Prevents access to .env, .git, etc.
        location ~ /\. {
            deny all;
            access_log off;
            log_not_found off;
        }
        
        # Deny access to sensitive Laravel files
        location ~ ^/(\.env|\.git|composer\.json|composer\.lock|package\.json|package-lock\.json|webpack\.mix\.js|artisan) {
            deny all;
            access_log off;
            log_not_found off;
        }
        
        # Cache static assets (images, CSS, JS)
        # WHY? Reduces server load and improves performance
        location ~* \.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2|ttf|eot)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
            access_log off;
        }
        
        # Deny access to Laravel storage (except public storage)
        location ~ ^/storage/app {
            deny all;
        }
        
        # Allow access to public storage (symlinked)
        location ~ ^/storage {
            try_files $uri $uri/ =404;
        }
        
        # Favicon handling
        location = /favicon.ico {
            access_log off;
            log_not_found off;
        }
        
        # Robots.txt handling
        location = /robots.txt {
            access_log off;
            log_not_found off;
        }
        
        # Health check endpoint (for Render)
        # WHY? Render uses this to verify container is healthy
        location /health {
            access_log off;
            return 200 "healthy\n";
            add_header Content-Type text/plain;
        }
    }
}

# ============================================================================
# CONFIGURATION SUMMARY
# ============================================================================
# 
# What this configuration does:
# 1. Runs Nginx as www-data user (security)
# 2. Auto-detects CPU cores for optimal performance
# 3. Listens on $PORT (Render requirement)
# 4. Sets document root to public/ (Laravel standard)
# 5. Routes all requests through index.php (Laravel routing)
# 6. Proxies PHP requests to PHP-FPM on port 9000
# 7. Serves static files directly (performance)
# 8. Denies access to sensitive files (.env, .git)
# 9. Caches static assets (images, CSS, JS)
# 10. Enables gzip compression (faster page loads)
# 11. Logs to stdout/stderr (Render captures logs)
# 12. Provides health check endpoint
#
# Request Flow:
# 1. Request arrives at Nginx on $PORT
# 2. If static file (.css, .js, .jpg): Nginx serves directly
# 3. If PHP file or route: Nginx proxies to PHP-FPM
# 4. PHP-FPM executes public/index.php
# 5. Laravel handles routing and returns response
# 6. PHP-FPM sends response to Nginx
# 7. Nginx sends response to client
#
# Security Features:
# - Hides Nginx version
# - Denies access to hidden files (.env, .git)
# - Denies PHP execution in storage/
# - Denies access to sensitive Laravel files
# - Runs as non-root user (www-data)
#
# Performance Features:
# - Gzip compression (smaller responses)
# - Static file caching (1 year expiry)
# - Sendfile enabled (kernel-level file transfers)
# - FastCGI buffering (better PHP-FPM performance)
# - Keepalive connections (connection reuse)
#
# Why Nginx + PHP-FPM?
# - Nginx: Excellent for static files, low memory usage
# - PHP-FPM: Process manager, better than mod_php
# - Separation: Nginx handles HTTP, PHP-FPM handles PHP
# - Scalability: Can scale Nginx and PHP-FPM independently
# - Industry standard: Used by major Laravel deployments
# ============================================================================
