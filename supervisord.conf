# ============================================================================
# Supervisor Configuration for Nginx + PHP-FPM
# ============================================================================
# 
# WHY Supervisor?
# - Docker containers should run one main process
# - We need both Nginx and PHP-FPM running
# - Supervisor manages multiple processes as one
# - Automatically restarts crashed processes
# - Production-grade process manager
# ============================================================================

[supervisord]
# Run in foreground (required for Docker)
nodaemon=true

# Log to stdout/stderr (Render captures this)
logfile=/dev/stdout
logfile_maxbytes=0
loglevel=info

# PID file location
pidfile=/var/run/supervisord.pid

[program:php-fpm]
# Command to start PHP-FPM
# WHY -F? Runs in foreground (required for supervisor)
# WHY -R? Allows running as root (we'll drop to www-data)
command=/usr/local/sbin/php-fpm -F -R

# Start automatically when supervisor starts
autostart=true

# Restart if it crashes
autorestart=true

# Number of seconds to wait before considering start successful
startsecs=5

# Number of restart attempts before giving up
startretries=3

# Log output to stdout/stderr
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0

# Priority (lower number = starts first)
priority=1

[program:nginx]
# Command to start Nginx
# WHY daemon off? Runs in foreground (required for supervisor)
command=/usr/sbin/nginx -g 'daemon off;'

# Start automatically when supervisor starts
autostart=true

# Restart if it crashes
autorestart=true

# Number of seconds to wait before considering start successful
startsecs=5

# Number of restart attempts before giving up
startretries=3

# Log output to stdout/stderr
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0

# Priority (higher number = starts after PHP-FPM)
# WHY? PHP-FPM must be ready before Nginx starts proxying to it
priority=2

# ============================================================================
# CONFIGURATION SUMMARY
# ============================================================================
# 
# What this does:
# 1. Starts PHP-FPM first (priority 1)
# 2. Starts Nginx second (priority 2)
# 3. Keeps both running in foreground
# 4. Automatically restarts if either crashes
# 5. Logs all output to stdout/stderr (Render captures)
#
# Process Flow:
# 1. Docker starts container
# 2. start.sh script runs
# 3. start.sh configures Nginx port
# 4. start.sh starts supervisor
# 5. Supervisor starts PHP-FPM
# 6. Supervisor starts Nginx
# 7. Container stays running (supervisor in foreground)
#
# Why this approach?
# - Single container (Render requirement)
# - Both services managed together
# - Automatic restart on failure
# - Clean shutdown handling
# - Production-grade process management
# ============================================================================
